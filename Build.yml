name:OnePlus_Pad_2_Pro
on:
  workflows_dispatch:
    inputs:
      KERNEL_SUFFIX:
          description: 'å†…æ ¸åç§°ä¿®æ”¹'
          required: true
          default: '-android15-8-g0261dbe3cf7e-ab12786384-4k'
      KERNEL_TIME:
          description: 'å†…æ ¸æ—¶é—´ä¿®æ”¹'
          required: true
          default: 'Wed Dec 11 19:16:38 UTC 2024'
      enable_feature_x:
          description: 'æ˜¯å¦å¯ç”¨KPM'
          required: false
          default: false
          type: boolean
      enable_feature_y:
        description: "æ˜¯å¦å¯ç”¨lz4kd"
        required: false
        default: false
        type: boolean
      enable_feature_z:
        description: "æ˜¯å¦æ·»åŠ é£é©°é©±åŠ¨"
        required: false
        default: false
        type: boolean
      enable_feature_b:
        description: "æ·»åŠ BBRæ§åˆ¶ç®—æ³•"
        required: false
        default: true
        type: boolean
        

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
        fetch-depth: 0
    
    - name: ğŸ“Š Check Disk Space (æ£€æŸ¥ç£ç›˜ç©ºé—´)
      run: |
        echo "æ„å»ºå‰ç£ç›˜ç©ºé—´ï¼š"
        df -h
    
    - name: ğŸ“¦ Configure Git (è®¾ç½®ä¸‹è½½è´¦æˆ·)
      run: |
        git config --global user.name "MoranOrz"
        git config --global user.email "authorz@aliyun.com"
      
    - name: ğŸ›  Configure APT caching (é…ç½®APTç¼“å­˜)
      run: |
        APT_CACHE_DIR="$HOME/apt-cache"
        mkdir -p "$APT_CACHE_DIR"/{archives,lists/partial}
        echo "Dir::Cache \"$APT_CACHE_DIR\";" | sudo tee /etc/apt/apt.conf.d/90user-cache
        echo "Dir::Cache::archives \"$APT_CACHE_DIR/archives\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
        echo "Dir::State::lists \"$APT_CACHE_DIR/lists\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
        echo "Acquire::Check-Valid-Until \"false\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
        echo "Acquire::Languages \"none\";" | sudo tee -a /etc/apt/apt.conf.d/90user-cache
        sudo chown -R $USER:$USER "$APT_CACHE_DIR"
    
    - name: ğŸ›  Cache APT packages (ç¼“å­˜APTåŒ…)
      uses: actions/cache@v3
      with:
        path: ${{ env.HOME }}/apt-cache
        key: ${{ runner.os }}-apt-${{ hashFiles('.github/workflows/Build.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-
    
    - name: ğŸ“¦ Install dependencies (å®‰è£…ä¾èµ–)
      run: |
        sudo rm -f /var/lib/apt/lists/lock /var/lib/dpkg/lock
        APT_CACHE_DIR="$HOME/apt-cache"
        mkdir -p "$APT_CACHE_DIR/lists/partial"
        sudo apt -o Dir::Cache="$APT_CACHE_DIR" update -qq
        sudo DEBIAN_FRONTEND=noninteractive apt -o Dir::Cache="$APT_CACHE_DIR" install -yq --no-install-recommends \
          python3 git curl ccache libelf-dev \
          build-essential flex bison libssl-dev \
          libncurses-dev liblz4-tool zlib1g-dev \
          libxml2-utils rsync unzip
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
    
    - name: ğŸ“¥ Restore ccache (è½½å…¥ æœºå‹ï¼š${{ env.DEVICES_NAME }}çš„ ccache ç¼“å­˜)
      uses: actions/cache@v3
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ccache-${{ runner.os }}-${{ github.ref }}-${{ env.REPO_MANIFEST }}
        restore-keys: |
          ccache-${{ runner.os }}-${{ env.REPO_MANIFEST }}-
          ccache-${{ runner.os }}-
    
    - name: ğŸ“¥ Init ccache (å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œåˆ™åˆå§‹åŒ–Cceche)
      run: |
        export CCACHE_COMPILERCHECK="%compiler% -dumpmachine; %compiler% -dumpversion"
        export CCACHE_NOHASHDIR="true"
        export CCACHE_HARDLINK="true"
        export CCACHE_DIR="${{ env.CCACHE_DIR }}"
        export CCACHE_MAXSIZE="8G"
        
        INIT_FLAG="$CCACHE_DIR/.ccache_initialized"
        if command -v ccache >/dev/null 2>&1; then
          if [ ! -f "$INIT_FLAG" ]; then
            echo "åˆå§‹åŒ– ccache ($CCACHE_DIR)..."
            mkdir -p "$CCACHE_DIR"
            ccache -M "$CCACHE_MAXSIZE"
            touch "$INIT_FLAG"
          else
            echo "ccache å·²åˆå§‹åŒ–ï¼Œè·³è¿‡"
          fi
        else
          echo "æœªå®‰è£… ccacheï¼Œè·³è¿‡"
        fi
        
      - name: ğŸ“¥ Install repo tool (ä¸‹è½½repoå·¥å…·)
        run: |
         curl https://storage.googleapis.com/git-repo-downloads/repo > ~/repo
         chmod a+x ~/repo
         sudo mv ~/repo /usr/local/bin/repo

      - name: ğŸ“¥ Initialize repo and sync (åˆå§‹åŒ–repoå¹¶åŒæ­¥å†…æ ¸æºç )
        run: |
         mkdir kernel_workspace && cd kernel_workspace
         repo init -u https://github.com/showdo/kernel_manifest.git -b refs/heads/oneplus/sm8750 -m ${REPO_MANIFEST}.xml --depth=1
         repo --trace sync -c -j$(nproc --all) --no-tags
         rm kernel_platform/common/android/abi_gki_protected_exports_* || echo "No protected exports!"
         rm kernel_platform/msm-kernel/android/abi_gki_protected_exports_* || echo "No protected exports!"
